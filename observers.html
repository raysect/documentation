

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7. Sampling and Observers &mdash; Raysect Documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/RaysectLogo_web.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/theme.css" type="text/css" />
  

  
    <link rel="top" title="Raysect Documentation" href="index.html"/>
        <link rel="next" title="8. Conventions" href="conventions.html"/>
        <link rel="prev" title="6. Materials" href="materials.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Raysect
          

          
            
            <img src="_static/RaysectLogo_web.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">2. Downloading and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="how_it_works.html">3. How it works</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart_guide.html">4. Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="primitives.html">5. Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="materials.html">6. Materials</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">7. Sampling and Observers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#observer-equation">7.1. Observer equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#monte-carlo-integration">7.2. Monte-Carlo Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#importance-sampling">7.3. Importance Sampling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#uniform-hemisphere-distribution">7.3.1. Uniform hemisphere distribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cosine-distribution">7.3.2. Cosine distribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sampling-the-lights">7.3.3. Sampling the lights</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#materials">7.4. Materials</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sampling-the-brdf">7.4.1. Sampling the BRDF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-importance-sampling">7.5. Multiple Importance Sampling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">8. Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">9. References</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">10. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="help.html">11. Need Help?</a></li>
</ul>
<p class="caption"><span class="caption-text">Demonstrations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="demonstrations/demonstrations.html">1. Core Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="demonstrations/demonstrations.html#examples-gallery">2. Examples Gallery</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api_reference/core/core.html">1. Raysect Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/primitives/primitives.html">2. Primitives Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_reference/optical/optical.html">3. Optical Module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Raysect</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>7. Sampling and Observers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/observers.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sampling-and-observers">
<h1>7. Sampling and Observers<a class="headerlink" href="#sampling-and-observers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="observer-equation">
<h2>7.1. Observer equation<a class="headerlink" href="#observer-equation" title="Permalink to this headline">¶</a></h2>
<p>The total intensity measured by an observing pixel is given be the integral of
the incident emission over the collecting solid angle <span class="math">\(\Omega\)</span> and surface
area <span class="math">\(A\)</span>.</p>
<div class="math">
\[I = \int_{A} \int_{\Omega} L_{i}(p, \omega_i) \times \cos (\theta_i) d\omega_i dA\]</div>
<p>Here, <span class="math">\(L_{i}(p, \omega_i)\)</span> is the incident emission at a given point <span class="math">\(p\)</span>
and incident angle <span class="math">\(\omega_i\)</span> on the observing surface. <span class="math">\(\cos (\theta_i)\)</span>
is a geometry factor describing the increase in effective observing area as the incident
rays become increasingly parallel to the surface.</p>
<div class="figure align-center" id="id1">
<img alt="_images/pixel_sampling.png" src="_images/pixel_sampling.png" />
<p class="caption"><span class="caption-text"><strong>Caption:</strong> Example sampling geometry for a pixel in a camera. (Image credit: Carr, M.,
Meakins, A., et. al. (2017))</span></p>
</div>
</div>
<div class="section" id="monte-carlo-integration">
<h2>7.2. Monte-Carlo Integration<a class="headerlink" href="#monte-carlo-integration" title="Permalink to this headline">¶</a></h2>
<p>The integral in the observer equation is exact but difficult to evaluate analytically
for most physically relevant scenes. Monte-Carlo integration is a technique for
approximating the value of an integral by simulating a random process with random
numbers.</p>
<p>The simplest form of Monte-Carlo integration is the average value method, which starts by
considering the integral</p>
<div class="math">
\[I = \int_{a}^{b} f(x) dx\]</div>
<p>The average value of the function <span class="math">\(f(x)\)</span> over the domain can be expressed in terms
of the integral over the same domain.</p>
<div class="math">
\[&lt;f&gt; = \frac{1}{b-a} \int_{a}^{b} f(x) dx = \frac{I}{b-a}\]</div>
<p>Therefore, through manipulation we can express our integral in terms of the average of
<span class="math">\(f(x)\)</span>. We can measure <span class="math">\(&lt;f(x)&gt;\)</span> by sampling <span class="math">\(f(x)\)</span> at <span class="math">\(N\)</span> points
<span class="math">\(x_1\)</span>, <span class="math">\(x_2\)</span>, ..., <span class="math">\(x_N\)</span> chosen randomly between <span class="math">\(a\)</span> and
<span class="math">\(b\)</span>.</p>
<div class="math">
\[I \approx \frac{b-a}{N} \sum_{i=1}^{N} f(x_i) = \frac{1}{N} \sum_{i=1}^{N} \frac{f(x_i)}{p(x_i)}\]</div>
<p><span class="math">\(p(x_i) = 1/(a-b)\)</span> is the uniform distribution we are sampling from. For a rectangular
pixel in a camera the sampling distributions would be uniformly distributed 2D points in the
square area <span class="math">\(A\)</span> and 3D vectors in the hemisphere <span class="math">\(\Omega\)</span>.</p>
<p>In general, the standard error on the approximation scales as <span class="math">\(1/\sqrt{N}\)</span> with
<span class="math">\(N\)</span> samples.</p>
</div>
<div class="section" id="importance-sampling">
<h2>7.3. Importance Sampling<a class="headerlink" href="#importance-sampling" title="Permalink to this headline">¶</a></h2>
<p>The average value formula works well for smoothly varying functions but becomes inefficient when
the integral contains steep gradients or a divergence, for example, a bright point light source.
The standard error on the integral estimator can become large in such circumstances.</p>
<p>We can get around these problems by drawing the sample points <span class="math">\(x_i\)</span> from a non-uniform
probability density function (i.e. higher density for regions with stronger emission). Formally, <span class="math">\(p(x_i)\)</span>
is defined as</p>
<div class="math">
\[p(x_i) = \frac{w(x_i)}{\int_{a}^{b} w(x) dx}\]</div>
<p>where <span class="math">\(w(x)\)</span> is the weight function describing the distribution of sampling points. <span class="math">\(p(x)\)</span> has
the same functional shape as <span class="math">\(w(x)\)</span> but has been normalised so that its integral is 1. For uniform
sampling, <span class="math">\(w(x) = 1\)</span> and <span class="math">\(p(x_i) = 1/(b-a)\)</span> recovering the average value formula.</p>
<p>For the general case function <span class="math">\(w(x)\)</span> the estimator for the integral is now</p>
<div class="math">
\[I \approx \frac{1}{N} \sum_{i=1}^{N} \frac{f(x_i)}{w(x_i)} \int_{a}^{b} w(x) dx\]</div>
<p>This is the fundamental formula of importance sampling and a generalisation of the average
value method. It allows estimation of the integral <span class="math">\(I\)</span> by performing
a weighted sum, which can be weighted to have higher density in regions of interest. The price we
pay is that the random samples are being drawn from a more complicated distribution.</p>
<p>Importance sampling exploits the fact that the Monte-Carlo estimator converges fastest when samples
are taken from a distribution p(x) that is similar to the function f(x) in the integrand
(i.e. concentrate the calculations where the integrand is high).</p>
<div class="section" id="uniform-hemisphere-distribution">
<h3>7.3.1. Uniform hemisphere distribution<a class="headerlink" href="#uniform-hemisphere-distribution" title="Permalink to this headline">¶</a></h3>
<p>When calculating the irradiance at an observer surface we need to sample a set of
randomly distributed unit vectors in a hemisphere oriented along the surface normal. The simplest
distribution would be the uniform distribution where all angles over <span class="math">\(2 \pi\)</span> have equal
probability of being sampled. The weighting distribution is <span class="math">\(w(\omega) = 1\)</span>. Thus the
distributions normalisation constant evaluates to the area of solid angle being sampled, similar to
the <span class="math">\(b-a\)</span> length scale for the 1D cartesian case.</p>
<div class="math">
\[c = \int_{0}^{2\pi} \int_{0}^{\frac{\pi}{2}} \sin(\theta) d\theta d\phi = 2 \pi\]</div>
<p>Therefore <span class="math">\(p(\omega)\)</span> for uniformly distributed vectors is</p>
<div class="math">
\[p(\omega) = \frac{1}{2 \pi}.\]</div>
<p>The estimator for the irradiance becomes</p>
<div class="math">
\[I = \frac{2 \pi}{N} \sum_{i=1}^{N} L_i(p, \omega_i) \cos(\theta_i)\]</div>
</div>
<div class="section" id="cosine-distribution">
<h3>7.3.2. Cosine distribution<a class="headerlink" href="#cosine-distribution" title="Permalink to this headline">¶</a></h3>
<p>As mentioned above, it is often advantageous to draw samples from a distribution with similar shape
to the function being integrated. The observer equation is weighted with a cosine theta term meaning
that samples near the top of the hemisphere are weighted much more than samples near the edge. Hence
it is useful to generate observer samples proportional to the cosine distribution.</p>
<div class="math">
\[w(\omega) = \cos(\theta)\]</div>
<p>The normalisation constant, <span class="math">\(c\)</span>, can be evaluated by integrating <span class="math">\(w(x)\)</span> over the domain.</p>
<div class="math">
\[c = \int_{0}^{2\pi} \int_{0}^{\frac{\pi}{2}} w(\omega) \sin(\theta) d\theta d\phi = \pi\]</div>
<p>Therefore <span class="math">\(p(\omega)\)</span> for a cosine distribution would be</p>
<div class="math">
\[p(\omega) = \frac{\cos(\theta)}{\pi}\]</div>
<p>and the estimator becomes</p>
<div class="math">
\[I = \frac{\pi}{N \cos(\theta)} \sum_{i=1}^{N} L_i(p, \omega_i) \cos(\theta) = \frac{\pi}{N} \sum_{i=1}^{N} L_i(p, \omega_i)\]</div>
<p>Note that the cosine factors have cancelled, which is makes sense since we are treating
the <span class="math">\(\cos(\theta)\)</span> term as the important distribution.</p>
</div>
<div class="section" id="sampling-the-lights">
<h3>7.3.3. Sampling the lights<a class="headerlink" href="#sampling-the-lights" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="materials">
<h2>7.4. Materials<a class="headerlink" href="#materials" title="Permalink to this headline">¶</a></h2>
<p>The amount of light that reaches a camera from a point on an object surface is
given by the sum of light emitted and reflected from other sources.</p>
<div class="math">
\[L_{O}(p, \omega_O) = \int_{\Omega} L_{i}(p, \omega_i) \times f(\omega_i, \omega_o) \times \cos (\theta_i) d\omega_i\]</div>
<p>This equation is the same as the observer equation with the addition of the
bidirectional reflectance distribution function (BRDF) term <span class="math">\(f(\omega_i , \omega_o )\)</span>.
The BRDF is a weighting function that describes the redistribution of incident light
into outgoing reflections and transmission/absorption. It is commonly approximated in
terms of two ideal material components, specular and diffuse reflections. Ideal specular
reflection behaves like a mirror where the incoming light is perfectly reflected into
one angle, <span class="math">\(f_s (\omega_i, \omega_o ) = \rho_s(\omega_i )\delta(\omega_i ,\omega_o )\)</span>.
An ideal diffuse surface (matte paper) will evenly redistribute incident light across all
directions and hence has no angular dependance, <span class="math">\(f_d (\omega_i , \omega_o ) = \rho_d /\pi\)</span>.
Real physical materials exhibit a complex combination of both behaviours in addition to
transmission and absorption.</p>
<div class="figure align-center" id="id2">
<img alt="_images/material_reflections.png" src="_images/material_reflections.png" />
<p class="caption"><span class="caption-text"><strong>Caption:</strong> Example geometry for light reflected from a material surface. (Image credit: Carr, M.,
Meakins, A., et. al. (2017))</span></p>
</div>
<div class="section" id="sampling-the-brdf">
<h3>7.4.1. Sampling the BRDF<a class="headerlink" href="#sampling-the-brdf" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="multiple-importance-sampling">
<h2>7.5. Multiple Importance Sampling<a class="headerlink" href="#multiple-importance-sampling" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="conventions.html" class="btn btn-neutral float-right" title="8. Conventions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="materials.html" class="btn btn-neutral" title="6. Materials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2017, Dr Alex Meakins.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.3.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>